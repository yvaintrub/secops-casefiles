ğŸ›¡ Cloud OAuth Abuse in Azure (Anonymized)
ğŸ“Œ Executive Summary

This case describes a cloud identity attack via a compromised OAuth app in Azure.
The attacker minted tokens, enumerated resources, and exfiltrated data from Blob storage, maintaining persistence by registering a new rogue application.

ğŸ¯ Outcome: cloud tenant identity compromise, rapid data theft, and persistence.

___________________________________________________________________________________________________________________________________________________________________

ğŸ–¼ Attack Flow (ASCII Diagram)

+-------------------------+
| External Attacker       |
| (Internet)              |
+-------------------------+
             |
             v
+-------------------------+
| Compromised OAuth App   |
| (Leaked Secret)         |
+-------------------------+
             |
             v
+-------------------------+
| Token Minting           |
| (Azure AD / Graph API)  |
+-------------------------+
             |
             v
+-------------------------+
| Resource Enumeration    |
| - VM list               |
| - Blob Storage          |
| - KeyVault Secrets      |
+-------------------------+
             |
             v
+-------------------------+
| Data Exfiltration       |
| (Blob â†’ External S3)    |
+-------------------------+
             |
             v
+-------------------------+
| Persistence             |
| Rogue App Registration  |
+-------------------------+

___________________________________________________________________________________________________________________________________________________________________

ğŸ“– Attack Narrative
-------------------------------------------------------------------------------------------------------
Stage 1 â€“ Initial Access

ğŸ”´ OAuth app client secret leaked (likely GitHub / config repo).

ğŸŸ¡ Attacker authenticated with:

POST https://login.microsoftonline.com/<tenant-id>/oauth2/v2.0/token
client_id=<app-id>&client_secret=<leaked-secret>&scope=https://graph.microsoft.com/.default

-------------------------------------------------------------------------------------------------------
Stage 2 â€“ Reconnaissance

ğŸ”´ Enumerated tenant resources via Graph API:

GET https://graph.microsoft.com/v1.0/subscribedSkus
GET https://management.azure.com/subscriptions?api-version=2020-01-01
GET https://management.azure.com/subscriptions/<id>/resourcegroups?api-version=2021-04-01


ğŸŸ¡ Queried KeyVault secrets:

GET https://management.azure.com/subscriptions/<id>/resourceGroups/rg/providers/Microsoft.KeyVault/vaults/vault/secrets?api-version=7.0

-------------------------------------------------------------------------------------------------------
Stage 3 â€“ Exfiltration & Persistence

ğŸ”´ Downloaded data from Blob storage using token:

az storage blob download-batch -d ./loot --account-name victimstorage --source sensitive-container


ğŸŸ¡ Registered new rogue OAuth app via Graph API:

POST https://graph.microsoft.com/v1.0/applications
{ "displayName": "AzureUpdateSvc", "passwordCredentials": [...] }

___________________________________________________________________________________________________________________________________________________________________

â±ï¸ Timeline (UTC)

| Time  | Event                                         |
| ----- | --------------------------------------------- |
| 11:05 | ğŸ”´ OAuth app secret abused â†’ token request    |
| 11:20 | ğŸŸ¡ Tokens minted (Graph API)                  |
| 11:35 | ğŸ”´ Resource enumeration (VMs, Blob, KeyVault) |
| 11:50 | ğŸ”´ Blob dump â†’ exfiltration                   |
| 12:15 | ğŸŸ¡ Rogue OAuth app registered for persistence |

___________________________________________________________________________________________________________________________________________________________________

ğŸ“‚ Artifacts (Synthetic / Azure Logs)

Azure AD Sign-In Log

{
  "time": "2025-07-21T11:05:12Z",
  "appId": "00000000-aaaa-bbbb-cccc-111111111111",
  "servicePrincipalName": "legacy-oauth-app",
  "ipAddress": "185.220.101.12",
  "status": "Success"
}


Azure Activity Log â€“ Blob Exfiltration

{
  "time": "2025-07-21T11:50:45Z",
  "operationName": "ListBlobs",
  "caller": "legacy-oauth-app",
  "resource": "victimstorage.blob.core.windows.net/sensitive-container",
  "bytesTransferred": "2.1GB",
  "clientIP": "185.220.101.12"
}


Azure AD Audit Log â€“ Rogue App

{
  "time": "2025-07-21T12:15:07Z",
  "activity": "Add application",
  "initiatedBy": "legacy-oauth-app",
  "targetResource": "AzureUpdateSvc",
  "result": "success"
}

___________________________________________________________________________________________________________________________________________________________________

ğŸ§¾ IOCs (Synthetic)

| Type       | Value                                  | Status         |
| ---------- | -------------------------------------- | -------------- |
| IP Address | `185.220.101.12`                       | Attacker infra |
| App ID     | `00000000-aaaa-bbbb-cccc-111111111111` | Compromised    |
| App Name   | `legacy-oauth-app`                     | Abused         |
| App Name   | `AzureUpdateSvc`                       | Rogue created  |
| Resource   | `victimstorage.blob.core.windows.net`  | Exfiltrated    |

___________________________________________________________________________________________________________________________________________________________________

ğŸ”‘ Key Findings

OAuth credential theft â†’ direct tenant compromise.

Sensitive data stolen within ~45 minutes.

Persistence via rogue app registration.

___________________________________________________________________________________________________________________________________________________________________

ğŸ—‚ï¸ MITRE ATT&CK Mapping

T1528 â€“ Steal Application Access Token

T1078 â€“ Valid Accounts (Cloud Identity)

T1530 â€“ Data from Cloud Storage

T1098.003 â€“ Account Manipulation: Cloud App

___________________________________________________________________________________________________________________________________________________________________

ğŸ‘€ Detection Use Cases

ğŸš¨ Alert on anomalous token minting from unusual IPs.

ğŸŸ¡ Detect app registrations outside approved change window.

ğŸŸ¡ Monitor Graph API calls to KeyVault / Blob Storage.

ğŸŸ¡ Alert on large data transfers from Blob.

___________________________________________________________________________________________________________________________________________________________________

ğŸ›¡ï¸ Recommendations

Rotate/revoke leaked OAuth app secrets immediately.

Prefer certificate-based auth over static client secrets.

Enforce MFA + Conditional Access for app management.

Monitor Azure AD Sign-In / Audit Logs for anomalous app behavior.

Restrict service principals with least privilege.
